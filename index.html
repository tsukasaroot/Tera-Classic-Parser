<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Queue Viewer</title>
</head>
<style>
	body {
		background-color: transparent !important; /* Ensure body is transparent */
	}

	/* Hide scrollbar for Chrome, Safari and Opera */
	body::-webkit-scrollbar {
		display: none;
	}

	/* Hide scrollbar for IE, Edge and Firefox */
	body {
		-ms-overflow-style: none; /* IE and Edge */
		scrollbar-width: none; /* Firefox */
	}

	.container {
		background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent container */
		border-radius: 10px;
		padding: 20px;
	}

	#grabber {
		cursor: crosshair !important;
		-webkit-app-region: drag;
	}

	.noselect {
		-webkit-touch-callout: none !important;; /* Disable callout on iOS */
		-webkit-user-select: none !important;; /* Disable text selection */
		-khtml-user-select: none !important;; /* Disable text selection */
		-moz-user-select: none !important;; /* Disable text selection */
		-ms-user-select: none !important;; /* Disable text selection */
		user-select: none !important; /* Disable text selection */
	}
</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">

<body>
	<div id="grabber" class="container">
		<div class="row">
			<div class="col">
				<h1 class="text-danger text-center mt-2">Queue Viewer</h1>
			</div>
		</div>
	</div>
	<hr>
	<div class="container">
		<div class="row">
			<h3 style="cursor:pointer!important;" data-bs-toggle="collapse" data-bs-target="#dungeons-t"
			    aria-expanded="false"
			    aria-controls="dungeons-t" class="noselect">List of
				players for each dungeon</h3>
			<div class="collapse show" id="dungeons-t">
				<table id="dungeons" class="responsive table display compact dataTable noselect"
				       data-bs-theme="dark"></table>
			</div>
		</div>
		<div class="row">
			<h3 style="cursor:pointer!important;" data-bs-toggle="collapse" data-bs-target="#bgs-t"
			    aria-expanded="false"
			    aria-controls="bgs-t" class="noselect">List of players for each battleground</h3>
			<div class="collapse show" id="bgs-t">
				<table id="bgs" class="responsive table display compact dataTable noselect" data-bs-theme="dark"></table>
			</div>
		</div>
		<div class="row my-2">
			<div id="queue" class="p-2 noselect">Waiting for queue events...</div>
		</div>
	</div>

	<div class="modal fade" id="apiKey" tabindex="-1" aria-labelledby="apiKeyLabel" aria-hidden="true"
	     data-bs-theme="light">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="apiKeyLabel">API Key Required</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Please enter your API Key to continue:</p>
					<input type="text" id="api-key-input" class="form-control" placeholder="Enter API Key">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" id="set-api-key-btn" class="btn btn-primary">Set API Key</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		const {ipcRenderer} = require('electron');
		const DataTable = require('datatables.net-bs5');

		ipcRenderer.on('queue-event', (event, data) => {
			document.getElementById('queue').innerText = `${data}`;
		});

		document.addEventListener('DOMContentLoaded', () => {
			let dungeonsQueue = new DataTable('#dungeons', {
				columns: [
					{title: 'Dungeon Name', data: 'name'},
					{title: 'Players in queue', data: 'count'},
				],
				data: [],
				responsive: true,
				paging: false,
				searching: false,
			});

			let bgsQueue = new DataTable('#bgs', {
				columns: [
					{title: 'Battleground Name', data: 'name'},
					{title: 'Players in queue', data: 'count'},
				],
				data: [],
				responsive: true,
				paging: false,
				searching: false,
			});

			ipcRenderer.on('api-key-required', () => {
				const apiKeyModal = new bootstrap.Modal(document.getElementById('apiKey'));
				apiKeyModal.show();

				document.getElementById('set-api-key-btn').addEventListener('click', (e) => {
					e.preventDefault();
					const apiKey = document.getElementById('api-key-input').value.trim();
					apiKeyModal.hide();

					if (apiKey) {
						ipcRenderer.send('set-api-key', apiKey);
					} else {
						alert('API Key is required to continue.');
					}
				});
			});

			ipcRenderer.on('api-key-set', () => {
				alert('API Key has been set successfully.');
			});

			fetchQueues();

			setInterval(() => {
				fetchQueues();
			}, 10 * 1000);

			async function fetchQueues() {
				const dataDungeonPromise = fetch('https://tera.digitalsavior.fr/matching/Yurian/dungeon', {
					method: 'GET',
					headers: {'Content-Type': 'application/json'}
				});

				const dataBgPromise = fetch('https://tera.digitalsavior.fr/matching/Yurian/bg', {
					method: 'GET',
					headers: {'Content-Type': 'application/json'}
				});

				try {
					const [dataDungeonResponse, dataBgResponse] = await Promise.all([dataDungeonPromise, dataBgPromise]);

					if (!dataDungeonResponse.ok || !dataBgResponse.ok) {
						throw new Error('Failed to fetch queues');
					}

					const dataDungeon = await dataDungeonResponse.json();
					const dataBg = await dataBgResponse.json();

					dungeonsQueue.clear();
					dungeonsQueue.rows.add(dataDungeon.dungeons);
					dungeonsQueue.draw();

					bgsQueue.clear();
					bgsQueue.rows.add(dataBg.bgs);
					bgsQueue.draw();
				} catch (error) {
					console.error('Error fetching queues:', error);
				}
			}
		});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
	        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
	        crossorigin="anonymous"></script>
</body>
</html>